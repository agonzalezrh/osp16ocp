- import_role:
    name: tripleo-container-tag
  name: Cinder Volume tag container image for pacemaker
  vars:
    container_image: registry.redhat.io/rhosp-rhel8/openstack-cinder-volume:16.2
    container_image_latest: cluster.common.tag/openstack-cinder-volume:pcmklatest
  when: step|int == 1
- block:
  - name: Check if rsyslog exists
    register: rsyslog_config
    shell: systemctl is-active rsyslog
  - block:
    - blockinfile:
        content: 'if $syslogfacility-text == ''{{facility}}'' and $programname ==
          ''haproxy'' then -/var/log/containers/haproxy/haproxy.log

          & stop

          '
        create: true
        path: /etc/rsyslog.d/openstack-haproxy.conf
      name: Forward logging to haproxy.log file
      register: logconfig
      vars:
        facility: local0
    - name: restart rsyslog service after logging conf change
      service:
        name: rsyslog
        state: restarted
      when: logconfig is changed
    when:
    - rsyslog_config is changed
    - rsyslog_config.rc == 0
  name: Configure rsyslog for HAproxy container managed by Pacemaker
  when: step|int == 1
- import_role:
    name: tripleo-container-tag
  name: HAproxy tag container image for pacemaker
  vars:
    container_image: registry.redhat.io/rhosp-rhel8/openstack-haproxy:16.2
    container_image_latest: cluster.common.tag/openstack-haproxy:pcmklatest
  when: step|int == 1
- include_role:
    name: tripleo_lvmfilter
  name: Run lvmfilter role
  when:
  - step|int == 1
- import_role:
    name: tripleo-container-tag
  name: MySQL tag container image for pacemaker
  vars:
    container_image: registry.redhat.io/rhosp-rhel8/openstack-mariadb:16.2
    container_image_latest: cluster.common.tag/openstack-mariadb:pcmklatest
  when: step|int == 1
- import_role:
    name: tripleo-container-tag
  name: OVN DBS tag container image for pacemaker
  vars:
    container_image: registry.redhat.io/rhosp-rhel8/openstack-ovn-northd:16.2
    container_image_latest: cluster.common.tag/openstack-ovn-northd:pcmklatest
  when: step|int == 1
- import_role:
    name: tripleo-container-tag
  name: RabbitMQ tag container image for pacemaker
  vars:
    container_image: registry.redhat.io/rhosp-rhel8/openstack-rabbitmq:16.2
    container_image_latest: cluster.common.tag/openstack-rabbitmq:pcmklatest
  when: step|int == 1
- block:
  - become: true
    delay: 5
    loop: '{{ lookup(''file'', tripleo_role_name + ''/docker_config.yaml'', errors=''ignore'')
      | default(''{}'', True) | from_yaml | recursive_get_key_from_dict(key=''image'')
      | unique }}'
    loop_control:
      loop_var: prefetch_image
    name: Pre-fetch all the containers
    podman_image:
      force: true
      name: '{{ prefetch_image }}'
      validate_certs: false
    retries: 5
  when:
  - (step|int) == 1
- import_role:
    name: tripleo-container-tag
  name: Redis tag container image for pacemaker
  vars:
    container_image: registry.redhat.io/rhosp-rhel8/openstack-redis:16.2
    container_image_latest: cluster.common.tag/openstack-redis:pcmklatest
  when: step|int == 1
- block:
  - failed_when: rsyslog_config.rc == 2
    name: Check if rsyslog exists
    register: rsyslog_config
    shell: systemctl list-unit-files --type=service | grep -q rsyslog
  - block:
    - copy:
        content: '# Fix for https://bugs.launchpad.net/tripleo/+bug/1776180

          local2.*                 /var/log/containers/swift/swift.log

          &                        stop

          '
        dest: /etc/rsyslog.d/openstack-swift.conf
      name: Forward logging to swift.log file
      register: logconfig
    - name: Restart rsyslogd service after logging conf change
      service: name=rsyslog state=restarted
      when:
      - logconfig is changed
    when:
    - rsyslog_config is changed
    - rsyslog_config.rc == 0
  name: Configure rsyslog for swift-proxy
  when: step|int == 1
- block:
  - failed_when: rsyslog_config.rc == 2
    name: Check if rsyslog exists
    register: rsyslog_config
    shell: systemctl list-unit-files --type=service | grep -q rsyslog
  - block:
    - copy:
        content: '# Fix for https://bugs.launchpad.net/tripleo/+bug/1776180

          local2.*                 /var/log/containers/swift/swift.log

          &                        stop

          '
        dest: /etc/rsyslog.d/openstack-swift.conf
      name: Forward logging to swift.log file
      register: logconfig
    - name: Restart rsyslogd service after logging conf change
      service: name=rsyslog state=restarted
      when:
      - logconfig is changed
    when:
    - rsyslog_config is changed
    - rsyslog_config.rc == 0
  name: Configure rsyslog for swift-storage
  when: step|int == 1
